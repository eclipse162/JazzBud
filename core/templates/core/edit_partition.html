{% extends 'core/base.html' %} {% load static %} {% load custom_filters %}
{%block title %} Edit a Partition {% endblock %} {% block content %}

<link
  rel="stylesheet"
  type="text/css"
  href="{% static 'css/album_page.css' %}" />
<link
  rel="stylesheet"
  type="text/css"
  href="{% static 'css/edit_partition.css' %}" />

<script>
  window.spotifyAccessToken = "{{ access_token }}";
  window.songID = "{{ track.spotify_song_id }}";
</script>
<script src="https://unpkg.com/htmx.org"></script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<script src="{% static '/js/partition.js' %}"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>

<main class="track-page">
  <div class="album-header">
    <div class="album-content">
      <div class="album-cover-container">
        <img
          src="{{ track.cover }}"
          alt="{{ track.name }}"
          class="album-cover" />
      </div>
      <div class="album-info">
        <h1 class="album-title">{{ track.title }}</h1>
        <p class="album-artist">
          <a
            href="{% url 'artist_page' track.artist|custom_slugify track.artist_id %}"
            class="artist-link">
            {{ track.artist }}
          </a>
          &nbsp;&middot;&nbsp;{{ track.release_year }}
        </p>
        <div class="player-container">
          <div class="controls">
            <button id="play-pause">▶️</button>
            <span id="current-time">0:00</span>
            <div class="progress-wrapper">
              <div class="progress-container">
                <div class="progress-bar" onclick="seekTrack(event)">
                  <div id="progress" class="progress"></div>
                </div>
              </div>
              <span class="duration">
                {{ track.track_length|ms_to_minutes_seconds }}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="editContainer">
    <div class="artist-section">
      <table class="artistTable">
        <tr>
          <td>
            <input
              type="text"
              placeholder="Search"
              name="q"
              class="artist-search"
              hx-get="{% url 'artist_search' %}"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#artist-results-1"
              oninput="showDropdown(this)" />
            <div id="artist-results-1" class="dropdown-container"></div>
          </td>
        </tr>
        <tr>
          <td>
            <input
              type="text"
              placeholder="Search"
              name="q"
              class="artist-search"
              hx-get="{% url 'artist_search' %}"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#artist-results-2"
              oninput="showDropdown(this)" />
            <div id="artist-results-2" class="dropdown-container"></div>
          </td>
        </tr>
        <tr>
          <td>
            <input
              type="text"
              placeholder="Search"
              name="q"
              class="artist-search"
              hx-get="{% url 'artist_search' %}"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#artist-results-3"
              oninput="showDropdown(this)" />
            <div id="artist-results-3" class="dropdown-container"></div>
          </td>
        </tr>
        <tr>
          <td>
            <input
              type="text"
              placeholder="Search"
              name="q"
              class="artist-search"
              hx-get="{% url 'artist_search' %}"
              hx-trigger="keyup changed delay:500ms"
              hx-target="#artist-results-4"
              oninput="showDropdown(this)" />
            <div id="artist-results-4" class="dropdown-container"></div>
          </td>
        </tr>
      </table>
    </div>

    <div class="waveform-section">
      <svg id="timeline" width="800" height="200"></svg>
    </div>
  </div>

  <button id="saveButton" class="save-button">Save All Segments</button>

  <script>
    const svg = d3.select("#timeline");
    const width = 800;
    const height = 300;

    const xScale = d3
      .scaleLinear()
      .domain([0, 100])
      .range([50, width - 50]);
    const yPositions = [30, 80, 130, 180]; // Fixed y positions for each artist

    const lineGenerator = d3
      .line()
      .x((d) => xScale(d.x))
      .y((d) => d.y)
      .curve(d3.curveBasis);

    function updateWaveforms() {
      svg.selectAll(".waveform-group").remove();

      const waveforms = svg
        .selectAll(".waveform-group")
        .data(artists)
        .enter()
        .append("g")
        .attr("class", "waveform-group")
        .attr("transform", (d, i) => `translate(0, ${yPositions[i]})`);

      waveforms.each(function (d, i) {
        const group = d3.select(this);

        let waveformData = [
          { x: 10, y: 0 },
          { x: 20, y: 10 },
          { x: 40, y: 0 },
          { x: 60, y: 20 },
          { x: 80, y: 0 },
        ];

        const path = group
          .append("path")
          .datum(waveformData)
          .attr("d", lineGenerator)
          .attr("fill", "none")
          .attr("stroke", d.color)
          .attr("stroke-width", 4);

        group.call(
          d3.drag().on("drag", function (event) {
            let newX = Math.max(50, Math.min(width - 50, event.x));
            group.attr(
              "transform",
              `translate(${newX - 50}, ${yPositions[i]})`
            );
          })
        );

        group
          .selectAll(".control-point")
          .data(waveformData)
          .enter()
          .append("circle")
          .attr("class", "control-point")
          .attr("cx", (d) => xScale(d.x))
          .attr("cy", (d) => d.y)
          .attr("r", 6)
          .attr("fill", d.color)
          .call(
            d3.drag().on("drag", function (event, d) {
              d.y = Math.max(-30, Math.min(30, event.y));
              d3.select(this).attr("cy", d.y);
              path.attr("d", lineGenerator);
            })
          );
      });
    }

    // Function to add artist and update waveform
    function addArtist(name, color) {
      artists.push({ name, color });
      updateWaveforms();
    }

    // Event listener for dropdown selection
    function showDropdown(input) {
      const dropdownId = input.getAttribute("hx-target");
      const dropdown = document.querySelector(dropdownId);

      dropdown.style.display = input.value.length >= 3 ? "block" : "none";

      dropdown.addEventListener("click", function (event) {
        if (event.target && event.target.closest(".dropdown-item")) {
          const artistItem = event.target.closest(".dropdown-item");
          const artistName = artistItem.dataset.name;
          const artistImage = artistItem.querySelector("img").src;
          const artistId = artistItem.dataset.id;

          input.value = artistName;

          const artistDisplay = document.createElement("div");
          artistDisplay.classList.add("artist-display");
          artistDisplay.innerHTML = `
        <img src="${artistImage}" alt="${artistName}" class="artist-image" />
        <div class="artist-info">
          <span class="artist-name">${artistName}</span>
          <button class="add-instrument-button" onclick="showInstrumentSearch('${artistId}')">Add Instrument</button>
        </div>
        <input type="hidden" class="artist-id" value="${artistId}" />
      `;

          const existingDisplay =
            input.parentNode.querySelector(".artist-display");
          if (existingDisplay) {
            existingDisplay.remove();
          }
          input.parentNode.appendChild(artistDisplay);

          dropdown.style.display = "none";
          input.style.display = "none";

          addArtist(artistName, d3.schemeCategory10[artists.length % 10]);
        }
      });
    }

    // Initialize with empty artists
    let artists = [];
  </script>
</main>
{% endblock %}
